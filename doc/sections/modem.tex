% 
% MODULE : modem
%

\newpage
\section{modem}
\label{module:modem}
The modem module implements a set of (mod)ulation/(dem)odulation schemes
for encoding information into signals.
%For the analog modems, samples are modulated according to...
For the digital modems, data bits are encoded into symbols representing
carrier frequency, phase, amplitude, etc.

\subsection{Analog modulation schemes}
\subsubsection{{\tt freqmodem} (analog FM)}
The {\tt freqmodem} object implements an analog frequency modulation (FM)
modulator and demodulator.
Two options for demodulation are possible...
[TODO: check this equation]
\[
    s(t) =  \exp\left\{
                j 2 \pi k f_c
                \int_{0}^{t}{
                    m(\tau)d\tau
                }
            \right\}
\]
where $-1 \le m(t) \le 1$ is the message signal, $f_c$ is the carrier
frequency, and $k$ is the modulation index.
The modulation index governs the relative bandwidth of the signal
[TODO: explain in more detail].
Its digital equivalent is
\[
    s(nT_s) =   \exp\left\{
                    j 2 \pi k f_c
                    \sum_{k=0}^{n}{
                        m(kT_s)
                    }
                \right\}
\]

\subsubsection{{\tt ampmodem} (analog AM)}
The {\tt ampmodem} object implements an analog amplitude modulation (AM)
modulator/demodulator pair.
Two transmission schemes are available: single side-band (SSB), and
double side-band (DSB).
For SSB, the receiver can either use a peak detector, or phase-locked loop
({\it not yet implemented}).
For DSB, the receiver uses a Costas loop for carrier frequency and phase
tracking.

Single side-band:
\[
    s_1(t) = \frac{1}{2}\Bigl(1+k m(t)\Bigr)e^{j 2 \pi f_c t}
\]
where $-1 \le m(t) \le 1$ is the message signal, $f_c$ is the carrier frequency,
and $k$ is the modulation index.

Double side-band:
\[
    s_2(t) = m(t)e^{j 2 \pi f_c t}
\]

\subsection{Continuous phase digital modulation schemes}
fsk, msk, etc. [NOTE: not yet implemented]

\subsection{Linear digital modulation schemes}
\label{module:modem:digital}
The {\tt modem} object realizes the linear digital modulation library in which
the information from a symbol is encoded into the amplitude and phase of a
sample.
The modem structure implements a variety of common modulation schemes,
including (differential) phase-shift keying, and (quadrature) amplitude-shift
keying.
The input/output relationship for modulation/demodulation for the {\tt modem}
object is
strictly one-to-one and is independent of any pulse shaping, or interpolation.
%This differs from {\tt cpmodem} in which the pulse shaping filter is
%integrated into the modem itself.

In general, linear modems demodulate by finding the closest of $M$ symbols in
the set $\mathcal{S}$ to the received symbol $\vec{r}$, viz
\[
    \underset{k \in \mathcal{S}}{\arg\min}
    \bigl\{
        \| \vec{r} - \vec{s}_k \|
    \bigr\}
\]
For arbitrary modulation schemes a linear search over all symbols in
$\mathcal{S}$ is required which has a complexity of $\ord(M^2)$, however one may
take advantage of symmetries in certain constellations to reduce this.
%For example, $M$-ary PSK distributes its symbols evenly throughout the phase
%of the transmitted signal...

\subsubsection{Usage}
\begin{description}
\item[{\tt modem\_modulate()}]
    converts an input symbol into an output sample
\item[{\tt modem\_demodulate()}]
    finds the closest symbol which matches the input sample
\item {\tt modem\_get\_demodulator\_phase\_error()}]
    returns an angle proportional to the phase error after demodulation.
    This value can be used in a phase-locked loop
    (see Section~\ref{module:nco:pll})
    to correct for carrier phase recovery.
\item[{\tt modem\_get\_demodulator\_evm()}]
    returns a value equal to the error vector magnitude after demodulation.
    The error vector is the difference between the received symbol and the
    estimated transmitted symbol, $e = r - \hat{s}$.
    The magnitude of the error vector is an indication to the
    signal-to-noise/distortion ratio at receiver.
\end{description}

While the same modem structure may be used for both modulation and
demodulation for most schemes, it is important to use separate objects
for differential-mode modems (e.g. {\tt MOD\_DPSK}) as the internal state
will change after each symbol.
It is usually good practice to keep separate instances of modulators and
demodulators.
This holds true for most any encoder/decoder pair in \liquid.

\subsubsection{Gray coding}
In order to reduce the number of bit errors in a digital modem,
all symbols are automatically Gray encoded;
adjacent symbols in a constellation differ by only one bit.
%
For example, the binary-coded decimal (bcd) value of 183 is {\tt 10110111}.
It has adjacent symbol 184 ({\tt 10111000}) which differs by 4 bits.
Assume the transmitter sends 183 without encoding.
If noise at the receiver were to cause it to demodulate the nearby symbol 184,
the result would be 4 bit errors.
%
Gray encoding is computed to the binary-coded decimal symbol
by applying an exclusive OR bitmask of itself shifted to the right by a
single bit.
\begin{verbatim}
        10110111    bcd_in (183)        10111000    bcd_in (184)
        .1011011    bcd_in >> 1         .1011100    bcd_in >> 1
xor :   --------                        --------
        11101100    gray_out (236)      11100100    gray_out (228)
\end{verbatim}
Notice that the two output symbols
236 ({\tt 11101100}) and
228 ({\tt 11100100}) differ by only one bit.
Now if noise caused the receiver were to demodulate a symbol error, it would
result in only a single bit error instead of 4 without Gray coding.

The decoding process is similar to encoding but slightly more involved.
Gray decoding is computed on an encoded input symbol
by adding to it (modulo 2) as many shifted versions of itself as it has bits.
\begin{verbatim}
        11101100    gray_in (236)       11100100    gray_in (228)
        .1110110    gray_in >> 1        .1110010    gray_in >> 1
        ..111011    gray_in >> 2        ..111001    gray_in >> 2
        ...11101    gray_in >> 3        ...11100    gray_in >> 3
        ....1110    gray_in >> 4        ....1110    gray_in >> 4
        .....111    gray_in >> 5        .....111    gray_in >> 5
        ......11    gray_in >> 6        ......11    gray_in >> 6
        .......1    gray_in >> 7        .......1    gray_in >> 7
xor :   --------                        --------
        10110111    gray_out (183)      10111000    gray_out (184)
\end{verbatim}
There are a few interesting characteristics of Gray encoding:
\begin{itemize}
\item the first bit never changes in encoding/decoding
\item there is a unique mapping between input and output symbols
\end{itemize}
It is also interesting to note that in linear modems (e.g. PSK), the
{\tt decoder} is actually applied to the symbol at the transmitter while the
{\tt encoder} is applied to the received symbol at the receiver.
%This is somewhat counterintuitive and is because...
In \liquid, Gray encoding and decoding are computed with the
{\tt gray\_encode()} {\tt gray\_decode()} methods, respectively.

\subsubsection{{\tt MOD\_PSK} (phase-shift keying)}
Demodulation is performed independent of the signal amplitude.
For an $M$-symbol constellation, the $k^{th}$ symbol is
\[
    s_k = e^{j 2 \pi k/M}
\]
where $k \in \{0,1,\ldots,M-1\}$.
Specific schemes include BPSK ($M=2$),
\[
    s_k = e^{j \pi k} =
    \begin{cases}
        +1 & k=0 \\
        -1 & k=1
    \end{cases}
\]
and QPSK ($M=4$)
\[
    s_k = e^{j\left(\pi k/4 + \frac{\pi}{4}\right)}
\]

%-------------------- FIGURE: PSK MODEM --------------------
\begin{figure}
\centering
\mbox{
  \subfigure[BPSK]
    {
      \includegraphics[trim = 15mm 0mm 15mm 0mm, clip, height=6cm]{figures.gen/modem_bpsk}
      \label{fig:modem:psk:2}
    } \quad
  \subfigure[QPSK]
    {
      \includegraphics[trim = 15mm 0mm 15mm 0mm, clip, height=6cm]{figures.gen/modem_qpsk}
      \label{fig:modem:psk:4}
    } \quad
}
\mbox{
  \subfigure[8-PSK]
    {
      \includegraphics[trim = 15mm 0mm 15mm 0mm, clip, height=6cm]{figures.gen/modem_8psk}
      \label{fig:modem:psk:8}
    } \quad
  \subfigure[16-PSK]
    {
      \includegraphics[trim = 15mm 0mm 15mm 0mm, clip, height=6cm]{figures.gen/modem_16psk}
      \label{fig:modem:psk:16}
    } \quad
}
% trim = left bottom right top
\caption{Phase-shift keying (PSK) modem}
\label{fig:modem:psk}
\end{figure}

\subsubsection{{\tt MOD\_DPSK} (differential phase-shift keying)}
Demodulation is performed independent of the signal amplitude.
The data are encoded using phase transitions, rather than absolute phase.
This allows the receiver to demodulate incoherently, but at a quality
degradation of 3dB.
\[
    s_k(n) = \exp\left\{
                \frac{
                    j 2 \pi \Bigl(k(n) - k(n-1)\Bigr)
                } {
                    M
                }
            \right\}
\]

\subsubsection{{\tt MOD\_APSK} (amplitude/phase-shift keying}
Amplitude/phase-shift keying is a specific form of quadrature amplitude
modulation where constellation points lie on concentric circles.
\begin{itemize}
\item constellation points are further apart than those of PSK/DPSK, resulting
      in an improved error performance,
\item phase recovery is improved over regular QAM as the constellation points
      are less sensitive to phase noise
\end{itemize}
Demodulation follows as a two-step process: first, the amplitude of the
received signal is evaluated to determine in which level (``ring'') the
transmitted symbol lies.
Once the level is determined, the appropriate symbol is chosen based on its
phase, similar to PSK demodulation.
Demodulation of APSK consumes slightly more clock cycles than the PSK and QAM
demodulators.

%-------------------- FIGURE: APSK MODEM --------------------
\begin{figure}
\centering
\mbox{
  \subfigure[4-APSK (1,3)]
    {
      \includegraphics[trim = 15mm 0mm 15mm 0mm, clip, height=6cm]{figures.gen/modem_4apsk}
      \label{fig:modem:apsk:4}
    } \quad
  \subfigure[8-PSK (1,7)]
    {
      \includegraphics[trim = 15mm 0mm 15mm 0mm, clip, height=6cm]{figures.gen/modem_8apsk}
      \label{fig:modem:apsk:8}
    } \quad
}
\mbox{
  \subfigure[16-APSK (4,12)]
    {
      \includegraphics[trim = 15mm 0mm 15mm 0mm, clip, height=6cm]{figures.gen/modem_16apsk}
      \label{fig:modem:apsk:16}
    } \quad
  \subfigure[32-APSK (4,12,16)]
    {
      \includegraphics[trim = 15mm 0mm 15mm 0mm, clip, height=6cm]{figures.gen/modem_32apsk}
      \label{fig:modem:apsk:32}
    } \quad
}
\mbox{
  \subfigure[64-APSK (4,14,20,26)]
    {
      \includegraphics[trim = 15mm 0mm 15mm 0mm, clip, height=6cm]{figures.gen/modem_64apsk}
      \label{fig:modem:apsk:64}
    } \quad
  \subfigure[128-APSK (8,18,24,36,42)]
    {
      \includegraphics[trim = 15mm 0mm 15mm 0mm, clip, height=6cm]{figures.gen/modem_128apsk}
      \label{fig:modem:apsk:128}
    } \quad
}
% trim = left bottom right top
\caption{Amplitude/phase-shift keying (APSK) modem}
\label{fig:modem:apsk}
\end{figure}

\subsubsection{{\tt MOD\_ASK} (amplitude-shift keying)}

\[
    s_k = \alpha ( 2 k - M - 1 )
\]
where $\alpha$ is a scaling factor to ensure $E\{s_k^2\}=1$,
\[
    \alpha = 
    \begin{cases}
    1               &   M=2     \\
    1/\sqrt{5}      &   M=4     \\
    1/\sqrt{21}     &   M=8     \\
    1/\sqrt{85}     &   M=16    \\
    1/\sqrt{341}    &   M=32    \\
    \sqrt{3}/M      &   M > 32
    \end{cases}
\]

%-------------------- FIGURE: ASK MODEM --------------------
\begin{figure}
\centering
\mbox{
  \subfigure[2-ASK]
    {
      \includegraphics[trim = 15mm 0mm 15mm 0mm, clip, height=6cm]{figures.gen/modem_2ask}
      \label{fig:modem:ask:2}
    } \quad
  \subfigure[4-ASK]
    {
      \includegraphics[trim = 15mm 0mm 15mm 0mm, clip, height=6cm]{figures.gen/modem_4ask}
      \label{fig:modem:ask:4}
    } \quad
}
\mbox{
  \subfigure[8-ASK]
    {
      \includegraphics[trim = 15mm 0mm 15mm 0mm, clip, height=6cm]{figures.gen/modem_8ask}
      \label{fig:modem:ask:8}
    } \quad
  \subfigure[16-ASK]
    {
      \includegraphics[trim = 15mm 0mm 15mm 0mm, clip, height=6cm]{figures.gen/modem_16ask}
      \label{fig:modem:ask:16}
    } \quad
}
% trim = left bottom right top
\caption{Pulse-amplitude modulation (ASK) modem}
\label{fig:modem:ask}
\end{figure}

\subsubsection{{\tt MOD\_QAM} (quadrature amplitude modulation)}
Also known as quadrature amplitude-shift keying, QAM modems encode data using
both the in-phase and quadrature components of a signal amplitude.
In fact, the symbol is split into independent in-phase and quadrature symbols
which are encoded separately as {\tt MOD\_ASK} symbols.
Gray encoding is applited to both the I and Q symbols separately to help
ensure minimal bit changes between adjacent samples across both in-phase and
quadrature-phase dimensions.
This is made evident in Figure~\ref{fig:modem:qam:64} where one can see that
the first three bits of the symbol encode the in-phase component of the
sample, and the last thre bits encode the quadrature component of the sample.
%
We may formally describe the encoded sample is
\[
    s_k = \alpha \{ ( 2 k_i - M_i - 1 ) + j(2 k_q - M_q - 1) \}
\]
where
$k_i$ is the in-phase symbol,
$k_q$ is the quadrature symbol,
$M_i = 2^{m_i}$ and $M_q = 2^{m_q}$, are the number of respective in-phase and
quadrature symbols,
$m_i=\lceil \log_2(M) \rceil$ and $m_q=\lfloor \log_2(M) \rfloor$ are the
number of respective in-phase and quadrature bits, and
$\alpha$ is a scaling factor to ensure $E\{s_k^2\}=1$,
\[
    \alpha = 
    \begin{cases}
    1/\sqrt{2}      &   M=4     \\
    1/\sqrt{6}      &   M=8     \\
    1/\sqrt{10}     &   M=16    \\
    1/\sqrt{26}     &   M=32    \\
    1/\sqrt{42}     &   M=64    \\
    1/\sqrt{106}    &   M=128   \\
    1/\sqrt{170}    &   M=256   \\
    1/\sqrt{426}    &   M=512   \\
    1/\sqrt{682}    &   M=1024  \\
    1/\sqrt{1706}   &   M=2048  \\
    1/\sqrt{2730}   &   M=4096  \\
    \sqrt{2/M}      &   \text{else}
    \end{cases}
\]


%-------------------- FIGURE: QAM MODEM --------------------
\begin{figure}
\centering
\mbox{
  \subfigure[8-QAM]
    {
      \includegraphics[trim = 15mm 0mm 15mm 0mm, clip, height=6cm]{figures.gen/modem_8qam}
      \label{fig:modem:qam:8}
    } \quad
  \subfigure[16-QAM]
    {
      \includegraphics[trim = 15mm 0mm 15mm 0mm, clip, height=6cm]{figures.gen/modem_16qam}
      \label{fig:modem:qam:16}
    } \quad
}
\mbox{
  \subfigure[32-QAM]
    {
      \includegraphics[trim = 15mm 0mm 15mm 0mm, clip, height=6cm]{figures.gen/modem_32qam}
      \label{fig:modem:qam:32}
    } \quad
  \subfigure[64-QAM]
    {
      \includegraphics[trim = 15mm 0mm 15mm 0mm, clip, height=6cm]{figures.gen/modem_64qam}
      \label{fig:modem:qam:64}
    } \quad
}
\mbox{
  \subfigure[128-QAM]
    {
      \includegraphics[trim = 15mm 0mm 15mm 0mm, clip, height=6cm]{figures.gen/modem_128qam}
      \label{fig:modem:qam:128}
    } \quad
  \subfigure[256-QAM]
    {
      \includegraphics[trim = 15mm 0mm 15mm 0mm, clip, height=6cm]{figures.gen/modem_256qam}
      \label{fig:modem:qam:256}
    } \quad
}
% trim = left bottom right top
\caption{Rectangular quaternary-amplitude modulation (QAM) modem}
\label{fig:modem:qam}
\end{figure}

\subsubsection{{\tt MOD\_ARB} (arbitrary modem)}
\liquid\ also allows the user to create their own modulation schemes by
designating the number of bits per symbol, and the full signal constellation.
Several pre-loaded arbitrary signal constellations are available.

%-------------------- FIGURE: ARB MODEM --------------------
\begin{figure}
\centering
\mbox{
  \subfigure[optimal 16-QAM]
    {
      \includegraphics[trim = 15mm 0mm 15mm 0mm, clip, height=6cm]{figures.gen/modem_arb16opt}
      \label{fig:modem:arb:16opt}
    } \quad
  \subfigure[64-VT]
    {
      \includegraphics[trim = 15mm 0mm 15mm 0mm, clip, height=6cm]{figures.gen/modem_arb64vt}
      \label{fig:modem:arb:64vt}
    } \quad
}
% trim = left bottom right top
\caption{Arbitrary constellation (ARB) modem}
\label{fig:modem:arb}
\end{figure}


