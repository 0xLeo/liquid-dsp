% 
% MODULE : nco (numerically-controlled oscillator)
%

\section{nco (numerically-controlled oscillator)}
\label{module:nco}
numerically-controlled oscillator: mix, pll

\subsection{{nco}}
\label{module:nco:nco}
The {\tt nco} object implements an oscillator with two options for internal
phase precision: {\tt LIQUID\_NCO} and {\tt LIQUID\_VCO}.
The {\tt LIQUID\_NCO} implements a numerically-controlled oscillator that uses
a look-up table to generate a complex sinusoid while
the {\tt LIQUID\_VCO} implements a ``voltage-controlled'' oscillator that uses
the {\tt sinf} and {\tt cosf} functions to generate a complex sinusoid.

\subsubsection{Interface}
\begin{itemize}
\item {\tt nco\_create()} creates an {\tt nco} object
\item {\tt nco\_destroy()} destroys an {\tt nco} object
\item {\tt nco\_reset()} clears in internal state of an {\tt nco} object
\item {\tt nco\_set\_frequency()} sets the frequency (phase step size)
\item {\tt nco\_adjust\_frequency()} increments the frequency (phase step size)
\item {\tt nco\_set\_phase()} sets the internal {\tt nco} phase
\item {\tt nco\_adjust\_phase()} increments the internal {\tt nco} phase
\item {\tt nco\_step()} increments the internal {\tt nco} phase by its
    internal frequency
\item {\tt nco\_get\_phase()} returns the internal phase
\item {\tt nco\_get\_frequency()} returns the internal frequency (phase step
    size)
\item {\tt nco\_sin()} returns $\sin(\theta)$
\item {\tt nco\_cos()} returns $\cos(\theta)$
\item {\tt nco\_sincos()} returns $\sin(\theta)$, $\cos(\theta)$
\item {\tt nco\_cexpf()} returns $e^{j\theta}$
\item {\tt nco\_mix\_up()} rotates an input vector by $e^{j\theta}$
\item {\tt nco\_mix\_down()} rotates an input vector by $e^{-j\theta}$
\end{itemize}

\subsection{{pll} (phase-locked loop)}
\label{module:nco:pll}
The phase-locked loop object provides a method for synchronizing oscillators
on different platforms.
It uses a second-order integrating loop filter to adjust the frequency of its
{\tt nco} based on an instantaneous phase error input.

The integrator has a transfer function $G(s) = K/s$.
For a given loop filter $F(s)$, the closed-loop transfer function becomes
\[
    H(s) = \frac{ G(s)F(s) }{ 1 + G(s)F(s) }
         = \frac{ KF(s)    }{ s + KF(s)    }
\]
where the loop gain $K$ absorbs all the gains in the loop.

\subsubsection{Active lag design}
From \cite{Best:1997}.
\[
    F(s) = \frac{1 + \tau_2 s}{1 + \tau_1 s}
\]
This gives a closed-loop transfer function
\[
    H(s) = \frac{
                \frac{K}{\tau_1} (1 + s\tau_2)
           } {
                s^2 + s\frac{1 + K\tau_2}{\tau_1} + \frac{K}{\tau_1}
           }
\]

\[
    \omega_n = \sqrt{\frac{K}{\tau_1}}
    \,\,\,\,\,\,
    \zeta = \frac{\omega_n}{2}\left(\tau_2 + \frac{1}{K}\right)
        \rightarrow
    \tau_1 = \frac{K}{\omega_n^2}
    \,\,\,\,\,\,
    \tau_2 = \frac{2\zeta}{\omega_n} - \frac{1}{K}
\]

The open-loop transfer function is
\[
    H'(s) = F(s)G(s) = K \frac{1 + \tau_2 s}{s + \tau_1 s^2}
\]
Taking the bilinear $z$-transform gives the digital filter:
\[
    H'(z) = H'(s)\Bigl.\Bigr|_{s = \frac{1}{2}\frac{1-z^{-1}}{1+z^{-1}}}
          = 2 K \frac{
                (1+\tau_2/2) + 2 z^{-1}     + ( 1 - \tau_2/2)z^{-2}
          } {
                (1+\tau_1/2) -\tau_1 z^{-1} + (-1 + \tau_1/2)z^{-2}
          }
\]



\subsubsection{Active PI design}
Active ``proportional plus integration''
\[
    F(s) = \frac{1 + \tau_2 s}{\tau_1 s}
\]
This gives a closed-loop transfer function
\[
    H(s) = \frac{
                \frac{K}{\tau_1} (1 + s\tau_2)
           } {
                s^2 + s\frac{K\tau_2}{\tau_1} + \frac{K}{\tau_1 + \tau_2}
           }
\]

\[
    \omega_n = \sqrt{\frac{K}{\tau_1}}
    \,\,\,\,\,\,
    \zeta = \frac{\omega_n \tau_2}{2}
        \rightarrow
    \tau_1 = \frac{K}{\omega_n^2}
    \,\,\,\,\,\,
    \tau_2 = \frac{2\zeta}{\omega_n}
\]

The open-loop transfer function is
\[
    H'(s) = F(s)G(s) = K \frac{1 + \tau_2 s}{\tau_1 s^2}
\]
Taking the bilinear $z$-transform gives the digital filter:
\[
    H'(z) = H'(s)\Bigl.\Bigr|_{s = \frac{1}{2}\frac{1-z^{-1}}{1+z^{-1}}}
          = 2 K \frac{
                (1+\tau_2/2) + 2 z^{-1}     + ( 1 - \tau_2/2)z^{-2}
          } {
                \tau_1/2 -\tau_1 z^{-1} + (\tau_1/2)z^{-2}
          }
\]


