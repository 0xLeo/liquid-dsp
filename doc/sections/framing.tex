% 
% MODULE : framing
%

\newpage
\section{framing}
\label{module:framing}
The framing module contains objects and methods for packaging data into
manageable frames and packets.
For convention, \liquid\ refers to a ``packet'' as a group of binary
data bytes (often with forward error-correction applied)
that need to be communicated over a wireless link.
By contrast, a ``frame'' is a representation of the data once it has been
properly partitioned, encapsulated, and modulated before transmitting over the
air.
Included in this module are the {\tt packetizer}, 
{\tt frame64}, and {\tt flexframe} structures which
greatly simplify over-the-air digital communication of raw data.

\subsection{{\tt packetizer}}
\label{module:framing:packetizer}
The \liquid\ packetizer is a structure for abstracting multi-level forward
error-correction from the user.
The packetizer accepts a buffer of uncoded data bytes and adds a
cyclic redundancy check (crc) before applying two levels of forward
error-correction and bit-level interleaving.
The user may choose any two supported FEC schemes (including none) and the
packetizer object will handle buffering and data management internally,
providing a truly abstract interface.
The same is true for the packet decoder which accepts an array
of possibly corrupt data and attempts to recover the original message using
the FEC schemes provided.
The packet decoder returns the validity of the resulting CRC as well as its
best effort of decoding the message.

%The {\tt packetizer} object (Section~\ref{module:framing:packetizer})
%uses two {\tt fec} objects (an inner and outer code) in conjunction with an
%{\tt interleaver} object (Section~\ref{module:interleaver})
%and a 32-bit cyclic redundancy check.

The packetizer also allows for re-structuring if the user wishes to change
error-correction schemes or data lengths.  This is accomplished with the
{\tt packetier\_recreate()} method.

Here is a minimal example demonstrating the packetizer's most basic
functionality:
\input{listings/packetizer.example.c.tex}

See also: fec module, {\tt examples/packetizer\_example.c}

\subsection{{\tt frame64}, {\tt flexframe} (basic framing structures)}
\label{module:framing:frames}
\liquid\ comes packaged with two basic framing structures: {\tt frame64} and
{\tt flexframe} which can be used with little modification to transmit data
over a wireless link.
The interface for both of these objects is intended to be as simple as
possible while allowing control over some of the parameters of the system.
On the transmitter side, the appropriate frame generator object is created,
configured, and executed.
The receiver side uses an appropriate frame synchronizer object which simply
picks packets of a stream of samples, invoking a callback function for each
packet it finds.
The simplicity of the receiver is that the frame synchronizer object
automatically reconfigures itself for packets of different size, modulation
scheme, and other parameters.

\subsubsection{{\tt frame64} description}
\label{module:framing:frames:frame64}
The {\tt framegen64} and {\tt framesync64} objects implement a basic framing
structure for communicating packetized data over the air.
The {\tt framegen64} object accepts a 12-byte header and 64-byte payload and
assemble a 1280sample frame.
Internally, the frame generator encodes the header and payload each with a
Hamming(12,8) block code, 16-bit cyclic redundancy check, and modulates the
result with a QPSK modem.
The header and payload are encapsulated with special phasing sequences, and
finally the resulting symbols are interpolated using a half-rate root-raised
cosine filter (see section~\ref{module:filter:firdes:rrcos}).

The true spectral efficiency of the frame is exactly $4/5$; 64 bytes of data
(512 bits) encoded into 640 symbols.
The {\tt frame64} structure has the advantage of simplicity but lacks the
ability for true flexibility.

\subsubsection{{\tt flexframe} description}
\label{module:framing:frames:flexframe}
The {\tt flexframegen} and {\tt flexframesync} objects are similar to their
{\tt frame[gen|sync]64} counterparts, however extend functionality to include
a number of options in structuring the frame.

\subsubsection{framing structures}
\label{module:framing:frames:structures}
Both frames consist of six basic parts:

%\begin{tabular*}{0.95\textwidth}{l@{\extracolsep{\fill}}lll}
%\toprule
%{\it name}      & {\it \# symbols}  & {\it \# bytes}& {\it description}  \\
%\otoprule
%ramp up         & 64                & -             & BPSK ramp up sequence \\
%phasing pattern & 64                & -             & BSPK preamble phasing pattern \\
%p/n sequence    & 64                & -             & BPSK p/n synchronization sequence \\
%header          & 256               & 32            & QPSK, $r=1/2$-coded header \\
%payload         & 512               & 64            & QPSK, $r=1/2$-coded payload \\
%ramp down.      & 64                & -             & ramp down sequence \\
%\bottomrule
%\end{tabular*}

% 
% FIGURE: framing:structure
%
\begin{figure}
\centering
  \includegraphics[trim = 0mm 0mm 0mm 0mm, clip, width=16cm]{figures.pgf/framing_structure}
\caption{framing structure}
\label{fig:module:framing:structure}
\end{figure}


\begin{description}
\item[{\sf ramp/up}]
    gracefully increases the output signal level to avoid ``key clicking'' and
    reduce spectral side-lobes in the transmitted signal.
    Furthermore, it allows the receiver's automatic gain control unit to
    lock on to the incoming signal, preventing sharp transitions in its
    output.
\item[{\sf preamble phasing}]
    is a BPSK pattern which flips phase for each transmitted symbol
    ({\tt +1,-1,+1,-1,$\ldots$}).
    This sequence serves several purposes but primarily to help the receiver's
    symbol synchronization circuit lock onto the proper timing phase.
    [This works] because the phasing pattern maximizes the number of symbol
    transitions [reword].
\item[{\sf p/n sequence}]
    is an $m$-sequence (see section~\ref{module:sequence}) exhibiting good
    auto- and cross-correlation properties.
    %The binary sequence is modulated using BPSK so that 
    This sequence aligns the frame synchronizers to the remainder of the
    frame, telling them when to start receiving and decoding the frame header,
    as well as if the phase of the received signal needs to be reversed.
    At this point, the receiver's AGC, carrier PLL, and timing PLL should all
    have locked.
    The p/n sequence is of length 64 for both the {\tt frame64} and
    {\tt flexframe} structures (63-bit $m$-sequence with additional padded
    bit).
\item[{\sf header}]
    is a fixed-length data sequence which contains a small amount of
    information about the rest of the frame.
    The headers for the {\tt frame64} and {\tt flexframe} structures are
    vastly different and are described independently.
\item[{\sf payload}]
    is the meat of the frame, containing the raw data to be transferred across
    the link.
    For the {\tt frame64} structure, the payload is fixed at 64 bytes (hence
    its moniker), encoded using the Hamming(12,8) code
    (section~\ref{module:fec}), and modulated using QPSK.
    The {\tt flexframe} structure has a variable length payload and can be
    modulated using whatever schemes the user desires, however forward
    error-correction is executed externally.
    In both cases the synchronizer object invokes the callback upon receiving
    the payload.
\item[{\sf ramp/down}]
    gracefully decreases the output signal level as per ramp/up.
\end{description}

A graphical depiction of the framing signal level can be seen in
figure~\ref{fig:module:framing:structure}.
The relative lengths of each section are not necessarily to scale,
particularly as the {\tt flexframe} structure allows many of these sections to
be variable in length.

NOTE: while the {\tt flexframegen} and {\tt flexframesync} objects are
intended to be used in conjunction with one another, the output of
{\tt flexframegen} requires matched-filtering interpolation before the
{\tt flexframesync} object can recover the data.


\subsubsection{the decoding process}
\label{module:framing:frames:decoding}
Both the {\tt frame64} and {\tt flexframe} objects operate very similarly in
their decoding process.
On the receiver, frames are pulled from a stream of input samples which can
exhibit channel impairments such as noise, sample timing offset, and carrier
frequency and phase offsets.
The receiver corrects for these impairments as best it can using various other
signal processing elements in \liquid\ and attempts to decode the frame.
If at any time a frame is decoded (even if improperly), its appropriate
user-defined callback function is invoked.

Internally, the frame synchronizers...
When seeking a frame the synchronizer initially sets its internal loop
bandwidths high for acquisition, including those for the automatic gain
control, symbol timing recovery, and carrier frequency/phase recovery.
This is known as {\em acquisition} mode, and is typical for packet-based
communications systems.
% ...
Once the p/n sequence has been found, the receiver assumes it has a sufficient
lock on the channel impairments and reduces its control loop bandwidths
significantly, moving to {\em tracking} mode.

At the heart of the decoder is the {\tt framesync\_props} object which governs
the behavior of the frame synchronizers.
\begin{description}
\item[{\tt agc\_bw0/agc\_bw1}]
    are the respective open/closed automatic gain control bandwidths.
\item[{\tt agc\_gmin/agc\_gmax}]
    are the respective maximum/minimum automatic gain control gain values.
\item[{\tt sym\_bw0/sym\_bw1}]
    are the respective open/closed symbol synchronizer bandwidths.
\item[{\tt pll\_bw0/pll\_bw1}]
    are the respective open/closed carrier phase-locked loop bandwidths.
\item[...]
\item[{\tt squelch\_enabled}]
\item[{\tt autosquelch\_enabled}]
\item[{\tt squelch\_threshold}]
\end{description}


\subsection{{\tt framesyncstats\_s}}
\label{module:framing:framesyncstats_s}

%
\begin{description}
\item[{\tt SNR}]
    an estimate of the received signal-to-noise ratio in dB.
\item[{\tt rssi}]
    an estimate of the received signal strength in dB.
\item[{\tt framesyms}]
    a pointer to an array of the frame symbols (e.g. QPSK) at complex
    baseband before demodulation.
\item[{\tt num\_framesyms}]
    the number of elements in {\tt framesyms}.
\item[{\tt mod\_scheme}]
    the modulation scheme of the frame (see Section~\ref{module:modem}).
\item[{\tt mod\_bps}]
    the modulation depth (bits per symbol) of the modulation scheme used
    in the frame.
\item[{\tt check}]
    the error-detection scheme used in the payload of the frame
    (see Section~\ref{module:fec}).
\item[{\tt fec0}]
    the inner forward error-correction code used in the payload
    (see Section~\ref{module:fec}).
\item[{\tt fec1}]
    the outer forward error-correction code used in the payload
    (see Section~\ref{module:fec}).
\end{description}
%
A simple way to display the information in an instance of
{\tt framesyncstats\_s} is to use the {\tt framesyncstats\_print()}
method.

