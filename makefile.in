# 
# Makefile for liquid SDR libraries
#

srcdir = @srcdir@
prefix = @prefix@
exec_prefix = @exec_prefix@
VPATH = @srcdir@

CC = @CC@
LIBS_AGC = agc.o
LIBS_ANN = ann.o ann_layer.o ann_neuron.o
LIBS_BUFFER = fbuffer.o cfbuffer.o uibuffer.o metadata.o port.o
LIBS_FEC = checksum.o crc.o
LIBS_FFT = fft_create_plan.o fft_execute.o
LIBS_FILTER = filter_common.o fir_filter.o rrcos.o window.o firdes.o \
			  decim.o decim2.o decim_create.o decim_execute.o
LIBS_INTERLEAVER = interleaver.o
LIBS_MATH = math.o matrix.o dotprod.o
LIBS_MODEM = modem.o modulate.o demodulate.o modem_common.o modem_create.o
LIBS_NCO = nco.o
#LIBS_OPTIM = 
LIBS_RANDOM = random.o scramble.o
#LIBS_SEQUENCE = 
#LIBS_UTILITY = 

LIBS = $(LIBS_AGC) $(LIBS_ANN) $(LIBS_BUFFER) \
	   $(LIBS_FEC) $(LIBS_FFT) $(LIBS_FILTER) $(LIBS_INTERLEAVER) \
	   $(LIBS_MATH) $(LIBS_MODEM) $(LIBS_NCO) $(LIBS_RANDOM)

AUTOTESTS = \
	src/buffer/tests/cbuffer_autotest.h \
	src/buffer/tests/sbuffer_autotest.h \
	src/fec/tests/checksum_autotest.h \
	src/fec/tests/crc_autotest.h \
	src/filter/tests/decim_autotest.h \
	src/filter/tests/firdes_autotest.h \
	src/filter/tests/fir_filter_autotest.h \
	src/interleaver/tests/interleaver_autotest.h \
	src/math/tests/math_autotest.h \
	src/modem/tests/modem_autotest.h \
	src/nco/tests/nco_autotest.h \
	src/random/tests/random_autotest.h

CFLAGS = -g -O2 -Wall @ARCH_OPTION@

SHARED_LIB = @SH_LIB@

all: libliquid.a $(SHARED_LIB)

install:
	@echo "installing..."
	mkdir -p @libdir@
	install -m 644 -p $(SHARED_LIB) libliquid.a @libdir@
	@REBIND@
	mkdir -p @includedir@
	install -m 644 -p include/liquid.h @includedir@
	
libliquid.a: $(LIBS)
	ar r $@ $^
	ranlib libliquid.a

# darwin
libliquid.dylib: $(LIBS)
	$(CC) -dynamiclib -install_name $@ -o $@ $^

# linux, et al
libliquid.so: $(LIBS)
	$(CC) -shared -Xlinker -soname=$@ -o $@ -Wl,-whole-archive $^ -Wl,-no-whole-archive -lc

$(LIBS_AGC) : %.o : src/agc/src/%.c
	$(CC) $(CFLAGS) -c $< -o $@

$(LIBS_ANN) : %.o : src/ann/src/%.c
	$(CC) $(CFLAGS) -c $< -o $@

$(LIBS_BUFFER) : %.o : src/buffer/src/%.c
	$(CC) $(CFLAGS) -c $< -o $@

$(LIBS_FEC) : %.o : src/fec/src/%.c
	$(CC) $(CFLAGS) -c $< -o $@

$(LIBS_FFT) : %.o : src/fft/src/%.c
	$(CC) $(CFLAGS) -c $< -o $@

$(LIBS_FILTER) : %.o : src/filter/src/%.c
	$(CC) $(CFLAGS) -c $< -o $@

$(LIBS_INTERLEAVER) : %.o : src/interleaver/src/%.c
	$(CC) $(CFLAGS) -c $< -o $@

$(LIBS_MATH) : %.o : src/math/src/%.c
	$(CC) $(CFLAGS) -c $< -o $@

$(LIBS_MODEM) : %.o : src/modem/src/%.c
	$(CC) $(CFLAGS) -c $< -o $@

$(LIBS_NCO) : %.o : src/nco/src/%.c
	$(CC) $(CFLAGS) -c $< -o $@

$(LIBS_RANDOM) : %.o : src/random/src/%.c
	$(CC) $(CFLAGS) -c $< -o $@

#
# Autotests
#
autotest_include.h: $(AUTOTESTS)
	python autotest/autotest_gen.py $(AUTOTESTS)

xautotest: autotest_include.h autotest/autotest.c $(LIBS)
	$(CC) $(CFLAGS) $(LIBS) -lm autotest/autotest.c -o xautotest

check: xautotest
	./xautotest -v

#
# Examples
#

clean:
	rm -f *.o $(SHARED_LIB) *.a

distclean: clean
	rm -f config.log config.cache config.status config.h makefile
	rm -rf autom4te.cache
