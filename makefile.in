# 
# Makefile for liquid SDR libraries
#

srcdir = @srcdir@
prefix = @prefix@
exec_prefix = @exec_prefix@
VPATH = @srcdir@

CC = @CC@
AR = @AR@

# Liquid modules
modules		:= modem utility

# Collect information in these variables
programs	:=
sources		:=
libraries	:=
extra_clean	:=
examples	:=
autotests	:=
benchmarks	:=

objects		= $(subst .c,.o,$(sources))
dependencies	= $(subst .c,.d,$(sources))

include_dirs	:= include
CFLAGS		+= $(addprefix -I ,$(include_dirs))
vpath %.h $(include_dirs)

# -g : debugging info
CFLAGS		+= -g -O2 -Wall @ARCH_OPTION@ @PROFILE_OPTION@ @DEBUG_OPTION@

MV	:= mv -f
RM	:= rm -f
SED	:= sed

all:

#
# Generate list of module.mk includes, e.g.
#    include src/utility/module.mk
#    include src/modem/module.mk
#
include $(patsubst %,src/%/module.mk,$(modules))

SHARED_LIB	= @SH_LIB@
.PHONY: all
all: libliquid.a $(SHARED_LIB)

.PHONY: libraries
libraries: $(libraries)

# Liquid library definition
libliquid.a: $(objects)
	ar r $@ $^
	ranlib $@

#
# gcc -dynamiclib -install_name libliquid.dylib -o libliquid.dylib libmodem.a libutility.a 
# darwin
libliquid.dylib: $(libraries)
	$(CC) -dynamiclib -install_name $@ -o $@ $^

# linux, et al
libliquid.so: $(LIBS)
	$(CC) -shared -Xlinker -soname=$@ -o $@ -Wl,-whole-archive $^ -Wl,-no-whole-archive


.PHONY: clean
clean:
	$(RM) $(objects)
	$(RM) $(programs)
	$(RM) $(libraries)
	$(RM) $(dependencies)
	$(RM) $(extra_clean)
	$(RM) $(SHARED_LIB)

%.d: %.c
	gcc -M $< | sed 's,\($(notdir $*)\.o\) *:,$(dir $@)\1 $@: ,' > $@.tmp
	mv $@.tmp $@

