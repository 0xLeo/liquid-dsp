# 
# Makefile for liquid SDR libraries
#

srcdir = @srcdir@
prefix = @prefix@
exec_prefix = @exec_prefix@
VPATH = @srcdir@

CC = @CC@

# Liquid modules
modules		:=	\
	buffer		\
	math		\
	modem 		\
	utility
#	filter		\

# Collect information in these variables
programs	:=
sources		:=
libraries	:=
extra_clean	:=
examples	:=
autotests	:=
benchmarks	:=

objects		= $(patsubst %.c,%.o,$(sources))
dependencies	= $(patsubst %.c,%.d,$(sources))

include_dirs	:= . include
INCLUDE_CFLAGS	= $(addprefix -I ,$(include_dirs))
CFLAGS		+= $(INCLUDE_CFLAGS)
vpath %.h $(include_dirs)

# -g : debugging info
CONFIG_CFLAGS	= @ARCH_OPTION@ @PROFILE_OPTION@ @DEBUG_OPTION@
CFLAGS		+= -g -O2 -Wall $(CONFIG_CFLAGS)
LDFLAGS		+= -lm
ARFLAGS		= r

MV	:= mv -f
RM	:= rm -f
SED	:= sed
AR	:= ar
RANLIB	:= ranlib

all:

#
# Generate list of module.mk includes, e.g.
#    include src/utility/module.mk
#    include src/modem/module.mk
#
include $(patsubst %,src/%/module.mk,$(modules))

SHARED_LIB	= @SH_LIB@
.PHONY: all
all: libliquid.a $(SHARED_LIB)

.PHONY: libraries
libraries: $(libraries)

# Liquid library definition
libliquid.a: $(objects)
	$(AR) $(ARFLAGS) $@ $^
	$(RANLIB) $@

#
# gcc -dynamiclib -install_name libliquid.dylib -o libliquid.dylib libmodem.a libutility.a 
# darwin
libliquid.dylib: $(libraries)
	$(CC) -dynamiclib -install_name $@ -o $@ $^

# linux, et al
libliquid.so: $(libraries)
	$(CC) -shared -Xlinker -soname=$@ -o $@ -Wl,-whole-archive $^ -Wl,-no-whole-archive

# Dependencies
%.d: %.c
	gcc -M $< | sed 's,\($(notdir $*)\.o\) *:,$(dir $@)\1 $@: ,' > $@.tmp
	mv $@.tmp $@

# Autotests
autotest_include.h: $(autotests)
	python autotest/autotest_gen.py $(autotests)

xautotest.o: autotest_include.h autotest/autotest.c
	$(CC) $(CFLAGS) autotest/autotest.c -c -o $@

xautotest: xautotest.o $(objects)
	$(CC) $(LDFLAGS) xautotest.o $(objects) -o $@

check: xautotest
	./xautotest -v

check-clean:
	$(RM) autotest_include.h xautotest.o xautotest

# Benchmarks
.PHONY: bench
BENCH_CFLAGS	= -Wall $(INCLUDE_CFLAGS) $(CONFIG_CFLAGS)
BENCH_LDFLAGS	= $(LDFLAGS) -pthread

benchmark_include.h: $(benchmarks)
	python bench/benchmarkgen.py $(benchmarks)

benchmark.o: benchmark_include.h bench/bench.c
	$(CC) $(BENCH_CFLAGS) -c bench/bench.c -o benchmark.o

benchmark: benchmark.o $(objects)
	$(CC) $(BENCH_LDFLAGS) benchmark.o $(objects) -o benchmark

bench: benchmark
	./benchmark

bench-clean:
	$(RM) benchmark_include.h benchmark.o benchmark

# Clean
.PHONY: clean
clean: check-clean bench-clean
	$(RM) $(objects)
	$(RM) $(programs)
	$(RM) $(libraries)
	$(RM) $(dependencies)
	$(RM) $(extra_clean)
	$(RM) $(SHARED_LIB)


